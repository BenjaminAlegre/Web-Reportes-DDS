<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pagina principal</title>
    <link rel="shortcut icon" href="../img/logo1.png" type="image/x-icon">
    <link rel="stylesheet" href="../stylesheets/paginaPrincipal.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>
<body>
<!-- Encabezado (Header) -->
<header>
    <div class="container-fluid">
        <!-- BARRA NAVEGACIÓN -->
        <div class="bg-light">
            <nav class="navbar navbar-expand-xl navbar-light bg-light border-3 border-bottom">
                <div class="container-fluid">
                    <a class="navbar-brand">
                        <img src="../img/logo1.png"
                             alt="logo" class="img-fluid with-border"/></a>
                    <a class="navbar-brand mx-auto">Monitoreo de Servicios públicos</a>
                    <button type="button"
                            class="navbar-toggler"
                            data-bs-toggle="collapse"
                            data-bs-target="#MenuNavegacion">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>

                <div id="MenuNavegacion" class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-3">
                        <li class="nav-item" style="background-color: firebrick">
                            <button type="button" id="cerrarSesion" class="btn html-editor-align-center">
                                <a href="/logout" style="text-decoration: none; color: black;">Cerrar sesion</a>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="btn html-editor-align-center" data-bs-toggle="modal" data-bs-target="#formularioModal">
                                Abrir Incidente
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="btn html-editor-align-center" data-bs-toggle="modal" data-bs-target="#formularioModal1">
                                Rankings Semanales Pesado
                            </button>
                        </li>

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle custom-dropdown" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="bi bi-gear"></i>
                            </a>
                            <style>
                                .dropdown-menu.custom-dropdown {
                                    background-color: #fff3cd;
                                }
                            </style>
                            <div class="dropdown-menu dropdown-menu-end custom-dropdown" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item" href="#">Editar perfil</a>
                                <a class="dropdown-item" href="#">Designar persona</a>
                                <a class="dropdown-item" href="#">Ver servicios</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>
</header>

<main style="max-height: 100vh; overflow-y: auto;">
    <section class="vh-100">
        <div class="container py-3">
            <h1 class="texto">Monitoreo de Estado de Servicios de Transporte Público y de Establecimientos</h1>
            <p>Este sitio web fue creado por estudiantes de Diseño de Sistemas con la finalidad de conocer los estados de servicios de distintas entidades</p>

            <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col col-xl-9">
                    <div class="card">

                        <div class="row g-0">

                            <div class="col-md col-lg d-flex align-items-center">
                                <div class="card-body p-4 p-lg-3">

                                    <div id="carousel " class="carousel slide" data-bs-ride="carousel">
                                        <div class="carousel-inner">
                                            <div class="carousel-item active" data-bs-interval="5000">
                                                <img src="../img/subte.jpg" class="d-block img-fluid" alt="Imagen 1">
                                            </div>
                                            <div class="carousel-item" data-bs-interval="5000">
                                                <img src="../img/tren.jpg" class="d-block img-fluid" alt="Imagen 2">
                                            </div>
                                            <div class="carousel-item" data-bs-interval="5000">
                                                <img src="../img/super.jpg" class="d-block img-fluid" alt="Imagen 3">
                                            </div>
                                            <div class="carousel-item" data-bs-interval="5000">
                                                <img src="../img/escalera.jpg" class="img-fluid d-block" alt="Imagen 4">
                                            </div>
                                            <div class="carousel-item" data-bs-interval="5000">
                                                <img src="../img/banio.jpg" class="d-block img-fluid" alt="Imagen 5">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="formularioModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Abrir Incidente</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Contenido del formulario -->
                            <form id="incidentForm" action="/aperturaIncidente/registrarIncidentePesado" method="POST" onsubmit="submitForm(); return false">

                                <div class="d-flex align-items-center mb-3 pb-1">
                                    <span class="h1 fw-bold mb-0">Apertura de Incidente</span>
                                </div>

                                <div class="form-outline mb-4">
                                    <label class="form-label">Entidades:</label>
                                    <select class="form-select form-select-lg"  aria-label="Default select example"
                                            id="entidades" name="entidadId" style="display:none"
                                            onchange="traerDatos(this, 'establecimiento','http://localhost:3000/establecimientosPorEntidad?entidad=')"  required>
                                        <option value="">Elija una opcion</option>
                                    </select>
                                </div>


                                <div class="form-outline mb-4">
                                    <label class="form-label">Establecimiento:</label>
                                    <select class="form-select form-select-lg"
                                            aria-label="Default select example"
                                            id="establecimiento"
                                            name="establecimientoId"
                                            style="display:none"
                                            onchange="traerDatos(this, 'servicio','http://localhost:3000/serviciosDeEstablecimiento?establecimiento=')"
                                            required>
                                        <option value="">Elija una opcion</option>
                                    </select>
                                </div>

                                <div class="form-outline mb-4">
                                    <label class="form-label">Servicio Afectado:</label>
                                    <select class="form-select form-select-lg"
                                            aria-label="Default select example"
                                            id='servicio'
                                            name="servicioId"
                                            style="display:none"
                                            required>
                                        <option value="">Elija una opcion</option>
                                    </select>
                                </div>


                                <div class="mb-3">
                                    <label for="exampleFormControlTextarea1"
                                           class="form-label">Observaciones</label>
                                    <textarea class="form-control" id="exampleFormControlTextarea1" name="observaciones"
                                              rows="3"></textarea>
                                </div>

                                <div class="pt-1 mb-4">
                                    <button class="btn btn-dark btn-lg btn-block"
                                            type="submit">Reportar</button>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="formularioModal1" tabindex="-1" aria-labelledby="exampleModalLabel1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel1">Rankings Semanales</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-outline mb-4">
                                <label class="form-label">Tipo de Rankings</label>
                                <select class="form-select form-select-lg" id="select"
                                        name="tipo" aria-label="Default select example" onchange="ocultarTabla()">
                                    <option value="">Seleccione ranking según entidades con...</option>

                                    <option value="RankTiempoDeCierre">Mayor tiempo promedio de tiempo de cierre de incidentes</option>
                                    <option value="RankCantidadIncidentes">Mayor cantidad de incidentes reportados en la semana</option>
                                    <option value="RankImpacto">Mayor grado de impacto de las problemáticas</option>
                                </select>
                                <div class="pt-2 mb-4">
                                    <button class="btn btn-dark btn-lg btn-block" onclick="mostarTabla()" >Buscar</button>
                                </div>
                            </div>
                            <div class="form-outline mb-4" id="tabla" style="display:none">
                                <table id="tablaValores" class="table mx-auto">
                                    <thead>
                                    <tr>
                                        <th>Posición</th>
                                        <th>Entidad</th>

                                    </tr>
                                    </thead>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<!-- Pie de página (Footer) -->
<footer class="footer bg-dark text-light text-center mt-8">
    <div class="container">
        <p>Derechos de autor © DDS - GRUPO 6 - UTN - 2023</p>
    </div>
</footer>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
<script>
document.addEventListener("DOMContentLoaded",  traerDatos(this,'entidades','http://localhost:3000/entidadesPorPrestadora?prestadora='));


    async function traerDatos(seleccionable, desplegable, ruta) {

        var x = seleccionable.value;
        var y= document.getElementById(desplegable);
        y.options.length = 0;
        y.options[0] =   new Option("Elija una opcion", "");
        y.style.display = "block";
        fetch(ruta+x)
                .then(response => response.json())
                .then(data => {
                    var x = document.getElementById(desplegable);
                    for (const valor of data.valores) {
                        x.options[x.options.length] = new Option(valor.nombre, valor.id);

                    }})
    }
    async function traerDatos2(seleccionable, desplegable, ruta){
        document.getElementById("lista").value=""
        const x = seleccionable.value;
        let lista = [];
        var y= document.getElementById(desplegable);
        y.style.display = "block";
        y.options.length = 0;
        y.options[0] =   new Option("", "");
        fetch(ruta+x)
                .then(response => response.json())
                .then(data => {
                    var x = document.getElementById(desplegable);
                    for (const valor of data.valores) {
                        x.options[x.options.length] = new Option(valor.nombre+" "+valor.tipo,valor.id);
                    }
                });
        $('#select-miembros').select2({
            data:lista});

    }

    function ocultarTabla(){
        x = document.getElementById("tabla")
        x.style.display ="none";
    }

    async function mostarTabla(){

        y=document.getElementById("select").value;
        document.getElementById('tablaValores').innerHTML="";
//         tabla.innerHTML='';
                                               var tbody = tabla.getElementsByTagName('tbody');
                                                 tbody.innerHTML = '';
        if(y === ""){
            alert('Por favor, elija una opción antes de continuar.');
        }
        else{
            fetch("http://localhost:3000/rankingsSemanales/buscarAsync?tipo="+y)
                    //  fetch("http://localhost:3000/establecimientosPorEntidad?entidad=1")
                    .then(response => response.json())
                    .then(data => {
                        var tabla = document.getElementById('tablaValores');
                                               var tbody = tabla.getElementsByTagName('tbody');
                                                 tbody.innerHTML = '';


                        for (const valor of data.valores) {
                            document.getElementById('tablaValores').insertRow(-1).innerHTML = '<td>'+valor.posicion+'</td><td>'+valor.nombreEntidad+'</td>';
                            console.log(valor.posicion);
                            console.log(valor.nombreEntidad);
                        }
                        var y= document.getElementById("tabla");
                        y.style.display = "block"; })

        }
    }

    function submitForm() {
        event.preventDefault();


        var entidadIdElement = document.getElementById('entidades');
        var servicioIdElement = document.getElementById('servicio');
        var observacionesElement = document.getElementById('exampleFormControlTextarea1');



        // Verificar si los elementos existen antes de acceder a sus propiedades
        if (entidadIdElement && servicioIdElement && observacionesElement) {
            var data = {
                entidadId: entidadIdElement.value,
                servicioId: servicioIdElement.value,
                observaciones: observacionesElement.value
            };

            $.ajax({
                type: 'POST',
                url: '/aperturaIncidente/registrarIncidentePesado',
                data: JSON.stringify(data),
                contentType: 'application/json',
                success: function(response) {
                    console.log(response);
                    $('#formularioModal').modal('hide');
                }

            });
        } else {
            console.error("Alguno de los elementos del formulario no existe.");
        }
}

</script>
</body>
</html>